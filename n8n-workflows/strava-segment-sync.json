{
    "name": "Strava-路段成績同步系統-修正版v2",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes",
                            "minutesInterval": 60
                        }
                    ]
                }
            },
            "id": "trigger-cron",
            "name": "每小時執行一次",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                200,
                300
            ]
        },
        {
            "parameters": {},
            "id": "trigger-manual",
            "name": "手動執行",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                200,
                140
            ]
        },
        {
            "parameters": {
                "operation": "select",
                "table": "segments",
                "returnAll": true,
                "filters": {
                    "conditions": [
                        {
                            "key": "is_active",
                            "value": "true"
                        }
                    ]
                }
            },
            "id": "get-segments",
            "name": "讀取啟用的路段",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                420,
                220
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "EUkgZj6J4zKucp2d",
                    "name": "zeabur"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "split-segments",
            "name": "逐路段處理",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                640,
                220
            ]
        },
        {
            "parameters": {
                "operation": "select",
                "table": "registrations",
                "filters": {
                    "conditions": [
                        {
                            "key": "segment_id",
                            "value": "={{ $json.id }}"
                        }
                    ]
                }
            },
            "id": "get-registrations",
            "name": "讀取該路段報名名單",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                860,
                220
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "EUkgZj6J4zKucp2d",
                    "name": "zeabur"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "split-registrations",
            "name": "逐選手處理",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                1080,
                220
            ]
        },
        {
            "parameters": {
                "operation": "select",
                "table": "strava_tokens",
                "filters": {
                    "conditions": [
                        {
                            "key": "athlete_id",
                            "value": "={{ $json.strava_athlete_id }}"
                        }
                    ]
                }
            },
            "id": "get-tokens",
            "name": "取得選手 Token",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1300,
                220
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "EUkgZj6J4zKucp2d",
                    "name": "zeabur"
                }
            }
        },
        {
            "parameters": {
                "url": "https://www.strava.com/api/v3/segment_efforts",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "Authorization",
                            "value": "=Bearer {{ $json.access_token }}"
                        }
                    ]
                },
                "sendQueryParameters": true,
                "queryParameters": {
                    "parameters": [
                        {
                            "name": "segment_id",
                            "value": "={{ $node[\"split-segments\"].json.id }}"
                        },
                        {
                            "name": "athlete_id",
                            "value": "={{ $json.athlete_id }}"
                        },
                        {
                            "name": "start_date_local",
                            "value": "={{ $node[\"split-segments\"].json.start_date }}"
                        },
                        {
                            "name": "end_date_local",
                            "value": "={{ $node[\"split-segments\"].json.end_date }}"
                        }
                    ]
                }
            },
            "id": "strava-api",
            "name": "Strava API 抓取",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1520,
                220
            ]
        },
        {
            "parameters": {
                "jsCode": "const segmentId = $node[\"split-segments\"].json.id;\nreturn items.map(item => {\n  const data = item.json;\n  if (Array.isArray(data)) {\n      return data.map(e => ({ json: mapEffort(e, segmentId) }));\n  }\n  return { json: mapEffort(data, segmentId) };\n}).flat();\n\nfunction mapEffort(e, segId) {\n  if (!e || !e.id) return null;\n  return {\n      id: e.id,\n      segment_id: segId,\n      athlete_id: e.athlete.id,\n      athlete_name: e.athlete.firstname + \" \" + (e.athlete.lastname || \"\"),\n      elapsed_time: e.elapsed_time,\n      moving_time: e.moving_time,\n      start_date: e.start_date,\n      average_watts: e.average_watts || null,\n      device_watts: e.device_watts || false\n    };\n}"
            },
            "id": "transform-data",
            "name": "資料轉換",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1740,
                220
            ]
        },
        {
            "parameters": {
                "operation": "upsert",
                "table": "segment_efforts",
                "columns": [
                    "id",
                    "segment_id",
                    "athlete_id",
                    "athlete_name",
                    "elapsed_time",
                    "moving_time",
                    "start_date",
                    "average_watts",
                    "device_watts"
                ]
            },
            "id": "upsert-supa",
            "name": "寫入資料庫",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1960,
                220
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "EUkgZj6J4zKucp2d",
                    "name": "zeabur"
                }
            }
        }
    ],
    "connections": {
        "每小時執行一次": {
            "main": [
                [
                    {
                        "node": "讀取啟用的路段",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "手動執行": {
            "main": [
                [
                    {
                        "node": "讀取啟用的路段",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "讀取啟用的路段": {
            "main": [
                [
                    {
                        "node": "逐路段處理",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "逐路段處理": {
            "main": [
                [
                    {
                        "node": "讀取該路段報名名單",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "讀取該路段報名名單": {
            "main": [
                [
                    {
                        "node": "逐選手處理",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "逐選手處理": {
            "main": [
                [
                    {
                        "node": "取得選手 Token",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "取得選手 Token": {
            "main": [
                [
                    {
                        "node": "Strava API 抓取",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Strava API 抓取": {
            "main": [
                [
                    {
                        "node": "資料轉換",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "資料轉換": {
            "main": [
                [
                    {
                        "node": "寫入資料庫",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "寫入資料庫": {
            "main": [
                [
                    {
                        "node": "逐選手處理",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}