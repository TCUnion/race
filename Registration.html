
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TCU Criterium - è³½äº‹å ±åï¼ˆç¶ ç•Œé‡‘æµï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 14px;
    }

    .price-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
    }
    .price-amount {
      font-size: 36px;
      font-weight: bold;
      margin: 0.5rem 0;
    }
    .price-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #f0f0f0;
    }
    .form-section:last-of-type {
      border-bottom: none;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group { margin-bottom: 1.5rem; }
    label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 14px;
    }
    label .required { color: #dc3545; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .input-hint { font-size: 12px; color: #6c757d; margin-top: 0.25rem; }

    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .payment-method {
      position: relative;
    }
    .payment-method input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .payment-method label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 1rem;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      height: 100%;
    }
    .payment-method input[type="radio"]:checked + label {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .payment-icon {
      font-size: 32px;
      margin-bottom: 0.5rem;
    }
    .payment-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .terms {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-size: 13px;
      line-height: 1.6;
      color: #666;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .checkbox-group label {
      margin-bottom: 0;
      cursor: pointer;
      font-weight: normal;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    .btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
    }
    .btn-primary:hover:not(:disabled) { 
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled { 
      background: #ccc; 
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }

    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: none;
      font-size: 14px;
      animation: slideDown 0.3s;
    }
    .message.show { display: block; }
    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    .error-message {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.show {
      display: flex;
    }
    .loading-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      text-align: center;
      max-width: 400px;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #ecpayForm { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš´ TCU Criterium è³½äº‹å ±å</h1>
    <p class="subtitle">è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šä¸¦å®Œæˆä»˜æ¬¾</p>

    <div id="successMessage" class="message success-message"></div>
    <div id="errorMessage" class="message error-message"></div>

    <div class="price-info">
      <div class="price-label">å ±åè²»ç”¨</div>
      <div class="price-amount" id="priceDisplay">NT$ 1,500</div>
      <div class="price-label">ç·šä¸Šåˆ·å¡/è¶…å•†ä»˜æ¬¾/ATMè½‰å¸³</div>
    </div>

    <form id="registrationForm" onsubmit="handleSubmit(event)">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <div class="form-section">
        <div class="section-title">
          <span>ğŸ‘¤</span>
          <span>åŸºæœ¬è³‡æ–™</span>
        </div>
        <div class="form-group">
          <label>å§“å <span class="required">*</span></label>
          <input type="text" id="name" name="name" required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
        </div>
        <div class="form-group">
          <label>Email <span class="required">*</span></label>
          <input type="email" id="email" name="email" required placeholder="example@email.com">
          <div class="input-hint">ç¹³è²»è³‡è¨Šèˆ‡å ±åç¢ºèªå°‡å¯„é€è‡³æ­¤ä¿¡ç®±</div>
        </div>
        <div class="form-group">
          <label>æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></label>
          <input type="tel" id="phone" name="phone" required placeholder="0912-345-678" pattern="[0-9]{10}">
        </div>
        <div class="form-group">
          <label>æ€§åˆ¥ <span class="required">*</span></label>
          <select id="gender" name="gender" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="M">ç”·æ€§</option>
            <option value="F">å¥³æ€§</option>
          </select>
        </div>
      </div>

      <!-- è³½äº‹è³‡è¨Š -->
      <div class="form-section">
        <div class="section-title">
          <span>ğŸ†</span>
          <span>è³½äº‹è³‡è¨Š</span>
        </div>
        <div class="form-group">
          <label>åƒè³½çµ„åˆ¥ <span class="required">*</span></label>
          <select id="category" name="category" required onchange="updatePrice()">
            <option value="">è«‹é¸æ“‡</option>
            <option value="pro" data-price="1500">èè‹±çµ„ - NT$ 1,500</option>
            <option value="amateur" data-price="1200">æ¥­é¤˜çµ„ - NT$ 1,200</option>
            <option value="junior" data-price="800">é’å°‘å¹´çµ„ - NT$ 800</option>
          </select>
        </div>
        <div class="form-group">
          <label>è¡£æœå°ºå¯¸</label>
          <select id="shirt_size" name="shirt_size">
            <option value="">è«‹é¸æ“‡</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="2XL">2XL</option>
          </select>
        </div>
      </div>

      <!-- ç·Šæ€¥è¯çµ¡äºº -->
      <div class="form-section">
        <div class="section-title">
          <span>ğŸš¨</span>
          <span>ç·Šæ€¥è¯çµ¡äºº</span>
        </div>
        <div class="form-group">
          <label>ç·Šæ€¥è¯çµ¡äººå§“å <span class="required">*</span></label>
          <input type="text" id="emergency_contact" name="emergency_contact" required placeholder="å§“å">
        </div>
        <div class="form-group">
          <label>ç·Šæ€¥è¯çµ¡é›»è©± <span class="required">*</span></label>
          <input type="tel" id="emergency_phone" name="emergency_phone" required placeholder="0912-345-678" pattern="[0-9]{10}">
        </div>
      </div>

      <!-- ä»˜æ¬¾æ–¹å¼ -->
      <div class="form-section">
        <div class="section-title">
          <span>ğŸ’³</span>
          <span>ä»˜æ¬¾æ–¹å¼</span>
        </div>
        <div class="payment-methods">
          <div class="payment-method">
            <input type="radio" id="payment_credit" name="payment_method" value="Credit" checked>
            <label for="payment_credit">
              <div class="payment-icon">ğŸ’³</div>
              <div class="payment-name">ä¿¡ç”¨å¡</div>
            </label>
          </div>
          <div class="payment-method">
            <input type="radio" id="payment_atm" name="payment_method" value="ATM">
            <label for="payment_atm">
              <div class="payment-icon">ğŸ¦</div>
              <div class="payment-name">ATM è½‰å¸³</div>
            </label>
          </div>
          <div class="payment-method">
            <input type="radio" id="payment_cvs" name="payment_method" value="CVS">
            <label for="payment_cvs">
              <div class="payment-icon">ğŸª</div>
              <div class="payment-name">è¶…å•†ä»£ç¢¼</div>
            </label>
          </div>
          <div class="payment-method">
            <input type="radio" id="payment_barcode" name="payment_method" value="BARCODE">
            <label for="payment_barcode">
              <div class="payment-icon">ğŸ“±</div>
              <div class="payment-name">è¶…å•†æ¢ç¢¼</div>
            </label>
          </div>
        </div>
      </div>

      <!-- å‚™è¨» -->
      <div class="form-section">
        <div class="form-group">
          <label>å‚™è¨»</label>
          <textarea id="notes" name="notes" rows="3" placeholder="å…¶ä»–éœ€è¦èªªæ˜çš„äº‹é …..."></textarea>
        </div>
      </div>

      <!-- åŒæ„æ¢æ¬¾ -->
      <div class="terms">
        <strong>é‡è¦é ˆçŸ¥ï¼š</strong><br>
        â€¢ å ±åè²»ç”¨åŒ…å«åƒè³½è³‡æ ¼ã€è™Ÿç¢¼å¸ƒã€å®Œè³½ç´€å¿µå“åŠä¿éšª<br>
        â€¢ å ±åå¾Œè‹¥å› å€‹äººå› ç´ ç„¡æ³•åƒè³½ï¼Œæ•ä¸é€€è²»<br>
        â€¢ å¦‚å› å¤©å€™ç­‰ä¸å¯æŠ—åŠ›å› ç´ å–æ¶ˆè³½äº‹ï¼Œå°‡æ‰£é™¤è¡Œæ”¿è²»ç”¨å¾Œé€€é‚„50%è²»ç”¨<br>
        â€¢ å®Œæˆä»˜æ¬¾å¾Œï¼Œå ±åè³‡æ–™å°‡ç„¡æ³•ä¿®æ”¹
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="agree_terms" required>
        <label for="agree_terms">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾åŠ<a href="privacy-policy.html" target="_blank">éš±ç§æ¬Šæ”¿ç­–</a> <span class="required">*</span></label>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="resetForm()">
          é‡è¨­è¡¨å–®
        </button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          å‰å¾€ä»˜æ¬¾ â†’
        </button>
      </div>
    </form>
  </div>

  <!-- è¼‰å…¥ä¸­é®ç½© -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>æ­£åœ¨è™•ç†è¨‚å–®...</h3>
      <p>è«‹ç¨å€™ï¼Œå³å°‡å‰å¾€ä»˜æ¬¾é é¢</p>
    </div>
  </div>

  <!-- ç¶ ç•Œä»˜æ¬¾è¡¨å–®ï¼ˆéš±è—ï¼Œç”¨æ–¼è‡ªå‹•æäº¤ï¼‰ -->
  <form id="ecpayForm" method="post" action="https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5">
    <!-- å°‡ç”±å¾Œç«¯å‹•æ…‹å¡«å…¥ -->
  </form>

  <script>
    const CONFIG = {
      // ä¿®æ”¹ç‚ºä½ çš„ n8n webhook URL
      createOrderUrl: 'https://n8n.criterium.tw/webhook/ecpay-create-order',
      // æ¸¬è©¦ç’°å¢ƒï¼šhttps://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5
      // æ­£å¼ç’°å¢ƒï¼šhttps://payment.ecpay.com.tw/Cashier/AioCheckOut/V5
      ecpayUrl: 'https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'
    };

    let currentPrice = 1500;

    function updatePrice() {
      const categorySelect = document.getElementById('category');
      const selectedOption = categorySelect.options[categorySelect.selectedIndex];
      const price = selectedOption.getAttribute('data-price');
      
      if (price) {
        currentPrice = parseInt(price);
        document.getElementById('priceDisplay').textContent = `NT$ ${currentPrice.toLocaleString()}`;
      }
    }

    function showMessage(type, message) {
      const messageEl = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
      messageEl.textContent = (type === 'error' ? 'âŒ ' : 'âœ… ') + message;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      
      // åŠ å…¥åƒ¹æ ¼è³‡è¨Š
      data.amount = currentPrice;
      
      console.log('æäº¤è¡¨å–®è³‡æ–™:', data);
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      showLoading(true);

      try {
        // å‘¼å« n8n webhook å»ºç«‹è¨‚å–®
        const response = await fetch(CONFIG.createOrderUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        console.log('å›æ‡‰ç‹€æ…‹:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('è¨‚å–®å»ºç«‹æˆåŠŸ:', result);

          // æª¢æŸ¥æ˜¯å¦æœ‰ä»˜æ¬¾è¡¨å–®åƒæ•¸
          if (result.ecpay_form) {
            // å‹•æ…‹å»ºç«‹ç¶ ç•Œä»˜æ¬¾è¡¨å–®
            const ecpayForm = document.getElementById('ecpayForm');
            ecpayForm.innerHTML = ''; // æ¸…ç©º
            ecpayForm.action = result.ecpay_form.action || CONFIG.ecpayUrl;

            // å¡«å…¥æ‰€æœ‰åƒæ•¸
            Object.keys(result.ecpay_form.params).forEach(key => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = key;
              input.value = result.ecpay_form.params[key];
              ecpayForm.appendChild(input);
            });

            // è‡ªå‹•æäº¤åˆ°ç¶ ç•Œ
            setTimeout(() => {
              console.log('è‡ªå‹•æäº¤åˆ°ç¶ ç•Œä»˜æ¬¾é é¢');
              ecpayForm.submit();
            }, 1000);

          } else {
            throw new Error('æœªæ”¶åˆ°ä»˜æ¬¾è¡¨å–®è³‡è¨Š');
          }

        } else {
          const errorText = await response.text();
          console.error('å»ºç«‹è¨‚å–®å¤±æ•—:', errorText);
          
          let errorMessage = 'è¨‚å–®å»ºç«‹å¤±æ•—';
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.message || errorData.error || errorMessage;
          } catch (e) {
            errorMessage = errorText || errorMessage;
          }
          
          throw new Error(errorMessage);
        }

      } catch (error) {
        console.error('æäº¤éŒ¯èª¤:', error);
        showMessage('error', error.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        showLoading(false);
        submitBtn.disabled = false;
      }
    }

    function resetForm() {
      if (confirm('ç¢ºå®šè¦é‡è¨­è¡¨å–®å—ï¼Ÿ')) {
        document.getElementById('registrationForm').reset();
        currentPrice = 1500;
        document.getElementById('priceDisplay').textContent = 'NT$ 1,500';
        document.getElementById('successMessage').classList.remove('show');
        document.getElementById('errorMessage').classList.remove('show');
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', function() {
      console.log('å ±åç³»çµ±å·²è¼‰å…¥');
      
      // é›»è©±è™Ÿç¢¼æ ¼å¼åŒ–
      const phoneInputs = document.querySelectorAll('input[type="tel"]');
      phoneInputs.forEach(input => {
        input.addEventListener('input', function(e) {
          // åªä¿ç•™æ•¸å­—
          this.value = this.value.replace(/\D/g, '');
        });
      });
    });
  </script>
</body>
</html>
