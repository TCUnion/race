{
    "name": "Manager Account Activation (v2 - With Auth Creation)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "GET",
                "path": "activate-manager",
                "options": {}
            },
            "id": "webhook-verify",
            "name": "Activation Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "schema": "public",
                "table": "manager_verifications",
                "filters": [
                    {
                        "column": "token",
                        "value": "={{ $json.query.token }}"
                    },
                    {
                        "column": "is_used",
                        "value": "false"
                    }
                ]
            },
            "id": "check-token",
            "name": "Check Token",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                450,
                300
            ],
            "alwaysOutputData": false,
            "continueOnFail": true
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $json.token }}",
                            "value2": "={{ $node[\"Activation Webhook\"].json.query.token }}"
                        }
                    ]
                }
            },
            "id": "validate-token",
            "name": "Is Token Valid?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "schema": "public",
                "table": "manager_roles",
                "filters": [
                    {
                        "column": "email",
                        "value": "={{ $node[\"Activation Webhook\"].json.query.email }}"
                    }
                ]
            },
            "id": "get-manager-data",
            "name": "Get Manager Data",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                850,
                200
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.SUPABASE_URL }}/auth/v1/admin/users",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "email",
                            "value": "={{ $node[\"Activation Webhook\"].json.query.email }}"
                        },
                        {
                            "name": "password",
                            "value": "={{ $json.pending_password }}"
                        },
                        {
                            "name": "email_confirm",
                            "value": "=true"
                        }
                    ]
                },
                "options": {}
            },
            "id": "create-auth-user",
            "name": "Create Auth User",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4,
            "position": [
                1050,
                200
            ]
        },
        {
            "parameters": {
                "operation": "update",
                "schema": "public",
                "table": "manager_roles",
                "updateColumns": [
                    "user_id",
                    "pending_password"
                ],
                "filters": [
                    {
                        "column": "email",
                        "value": "={{ $node[\"Activation Webhook\"].json.query.email }}"
                    }
                ],
                "columns": {
                    "user_id": "={{ $json.id }}",
                    "pending_password": null
                }
            },
            "id": "activate-role",
            "name": "Link Auth User",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1250,
                200
            ]
        },
        {
            "parameters": {
                "operation": "update",
                "schema": "public",
                "table": "manager_verifications",
                "updateColumns": [
                    "is_used"
                ],
                "filters": [
                    {
                        "column": "token",
                        "value": "={{ $node[\"Activation Webhook\"].json.query.token }}"
                    }
                ],
                "columns": {
                    "is_used": true
                }
            },
            "id": "mark-used",
            "name": "Mark Token Used",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1450,
                200
            ]
        },
        {
            "parameters": {
                "options": {
                    "responseCode": 200,
                    "responseBody": "<!DOCTYPE html><html lang=\"zh-TW\"><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>Email 驗證成功 | TCU Manager</title><link rel=\"preconnect\" href=\"https://fonts.googleapis.com\"><link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap\" rel=\"stylesheet\"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);display:flex;align-items:center;justify-content:center;padding:20px;overflow:hidden}.bg-glow{position:fixed;width:600px;height:600px;border-radius:50%;filter:blur(120px);opacity:0.3;animation:pulse 4s ease-in-out infinite}.bg-glow-1{background:#10b981;top:-200px;left:-200px}.bg-glow-2{background:#3b82f6;bottom:-200px;right:-200px;animation-delay:2s}@keyframes pulse{0%,100%{transform:scale(1);opacity:0.3}50%{transform:scale(1.1);opacity:0.4}}.card{position:relative;background:rgba(255,255,255,0.03);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:48px 40px;max-width:420px;width:100%;text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}.icon-container{width:80px;height:80px;margin:0 auto 24px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 40px rgba(16,185,129,0.4);animation:bounce 0.6s ease-out}@keyframes bounce{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}.icon-container svg{width:40px;height:40px;color:white}.badge{display:inline-block;background:rgba(16,185,129,0.15);color:#34d399;font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;padding:6px 14px;border-radius:20px;margin-bottom:16px}h1{color:#ffffff;font-size:28px;font-weight:800;margin-bottom:12px}.subtitle{color:#94a3b8;font-size:15px;line-height:1.6;margin-bottom:24px}.contact-info{color:#64748b;font-size:13px;margin-bottom:32px}.contact-link{color:#10b981;text-decoration:none;font-weight:700;transition:color 0.2s}.contact-link:hover{color:#34d399}.btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:white;text-decoration:none;font-weight:600;font-size:15px;padding:14px 28px;border-radius:12px;transition:all 0.3s ease;box-shadow:0 4px 20px rgba(59,130,246,0.4)}.btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(59,130,246,0.5)}.btn svg{width:18px;height:18px}.footer{margin-top:32px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.1)}.footer p{color:#64748b;font-size:12px}</style></head><body><div class=\"bg-glow bg-glow-1\"></div><div class=\"bg-glow bg-glow-2\"></div><div class=\"card\"><div class=\"icon-container\"><svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"3\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M5 13l4 4L19 7\"/></svg></div><span class=\"badge\">✓ 驗證完成</span><h1>Email 驗證成功！</h1><p class=\"subtitle\">恭喜您！您的 Email 已成功驗證。<br>目前帳號正在進行管理員審核，通過後將發送通知。</p><p class=\"contact-info\">如有任何疑問請洽 <a href=\"https://page.line.me/criterium\" target=\"_blank\" class=\"contact-link\">TCU Line@官方</a></p><a href=\"https://strava.criterium.tw/manager.html\" class=\"btn\"><svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1\"/></svg>前往登入</a><div class=\"footer\"><p>© 2026 Taiwan Cycling Union. All rights reserved.</p></div></div></body></html>"
                }
            },
            "id": "success-page",
            "name": "Show Success",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1650,
                200
            ]
        },
        {
            "parameters": {
                "options": {
                    "responseCode": 400,
                    "responseBody": "<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>啟用失敗</title><style>body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif;background:#f4f7f9;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}.card{background:#fff;padding:40px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;max-width:400px}.icon{font-size:48px;margin-bottom:20px;color:#ef4444}h1{color:#1e293b;margin:0 0 10px;font-size:24px}p{color:#64748b;line-height:1.5;margin-bottom:30px}</style></head><body><div class=\"card\"><div class=\"icon\">⚠️</div><h1>連結無效或已過期</h1><p>請確認您是否已經啟用過，<br>或聯繫系統管理員。</p></div></body></html>"
                }
            },
            "id": "error-page",
            "name": "Show Error",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                850,
                400
            ]
        }
    ],
    "connections": {
        "Activation Webhook": {
            "main": [
                [
                    {
                        "node": "Check Token",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Token": {
            "main": [
                [
                    {
                        "node": "Is Token Valid?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Token Valid?": {
            "main": [
                [
                    {
                        "node": "Get Manager Data",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Show Error",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Manager Data": {
            "main": [
                [
                    {
                        "node": "Create Auth User",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Auth User": {
            "main": [
                [
                    {
                        "node": "Activate Account",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Activate Account": {
            "main": [
                [
                    {
                        "node": "Mark Token Used",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Mark Token Used": {
            "main": [
                [
                    {
                        "node": "Show Success",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}