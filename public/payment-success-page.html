<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å ±åæˆåŠŸ - TCU Criterium</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }

    .success-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      animation: scaleIn 0.5s ease-out;
    }
    
    @keyframes scaleIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 1rem;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .info-card {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e9ecef;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #666;
      font-size: 14px;
      font-weight: 600;
    }

    .info-value {
      color: #333;
      font-size: 14px;
      font-weight: 500;
    }

    .highlight {
      color: #667eea;
      font-weight: 700;
    }

    .notice-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: left;
    }

    .notice-box strong {
      color: #856404;
      display: block;
      margin-bottom: 0.5rem;
    }

    .notice-box p {
      color: #856404;
      font-size: 13px;
      line-height: 1.6;
      margin: 0.25rem 0;
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid #f0f0f0;
      color: #999;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-icon {
      font-size: 50px;
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container" id="content">
    <div class="loading">
      <div class="spinner"></div>
      <p>æ­£åœ¨è¼‰å…¥è¨‚å–®è³‡è¨Š...</p>
    </div>
  </div>

  <script>
    const CONFIG = {
      // æŸ¥è©¢è¨‚å–®ç‹€æ…‹çš„ APIï¼ˆå¯é¸ï¼‰
      checkOrderUrl: 'https://n8n.criterium.tw/webhook/check-order-status'
    };

    // å¾ URL åƒæ•¸å–å¾—è³‡è¨Š
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        orderNo: params.get('MerchantTradeNo') || params.get('order_no'),
        rtnCode: params.get('RtnCode'),
        rtnMsg: params.get('RtnMsg'),
        tradeNo: params.get('TradeNo'),
        tradeAmt: params.get('TradeAmt'),
        paymentDate: params.get('PaymentDate'),
        paymentType: params.get('PaymentType'),
        // è‡ªè¨‚æ¬„ä½
        name: params.get('CustomField1'),
        email: params.get('CustomField2'),
        phone: params.get('CustomField3'),
        category: params.get('CustomField4')
      };
    }

    // é¡¯ç¤ºæˆåŠŸé é¢
    function showSuccess(data) {
      const categoryNames = {
        'pro': 'èè‹±çµ„',
        'amateur': 'æ¥­é¤˜çµ„',
        'junior': 'é’å°‘å¹´çµ„'
      };

      const paymentTypeNames = {
        'Credit_CreditCard': 'ä¿¡ç”¨å¡',
        'ATM_LAND': 'ATM è½‰å¸³',
        'CVS_CVS': 'è¶…å•†ä»£ç¢¼',
        'BARCODE_BARCODE': 'è¶…å•†æ¢ç¢¼'
      };

      document.getElementById('content').innerHTML = `
        <div class="success-icon">âœ“</div>
        
        <h1>ğŸ‰ å ±åæˆåŠŸï¼</h1>
        <p class="subtitle">
          æ„Ÿè¬æ‚¨å ±å TCU Criterium è³½äº‹<br>
          ä»˜æ¬¾å·²å®Œæˆï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„å ±åè³‡æ–™
        </p>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">è¨‚å–®ç·¨è™Ÿ</span>
            <span class="info-value highlight">${data.orderNo || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">å ±åè€…</span>
            <span class="info-value">${data.name || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">åƒè³½çµ„åˆ¥</span>
            <span class="info-value">${categoryNames[data.category] || data.category || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ä»˜æ¬¾é‡‘é¡</span>
            <span class="info-value highlight">NT$ ${data.tradeAmt ? parseInt(data.tradeAmt).toLocaleString() : '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ä»˜æ¬¾æ–¹å¼</span>
            <span class="info-value">${paymentTypeNames[data.paymentType] || data.paymentType || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ä»˜æ¬¾æ™‚é–“</span>
            <span class="info-value">${data.paymentDate || '-'}</span>
          </div>
        </div>

        <div class="notice-box">
          <strong>ğŸ“§ é‡è¦é€šçŸ¥</strong>
          <p>â€¢ å ±åç¢ºèªä¿¡å·²å¯„é€è‡³æ‚¨çš„ä¿¡ç®±ï¼š<strong>${data.email || '-'}</strong></p>
          <p>â€¢ è«‹æª¢æŸ¥ä¿¡ç®±ï¼ˆåŒ…å«åƒåœ¾éƒµä»¶å¤¾ï¼‰</p>
          <p>â€¢ è³½å‰ä¸€é€±å°‡å¯„é€è©³ç´°è³½äº‹è³‡è¨Š</p>
          <p>â€¢ å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹è¯ç¹«ä¸»è¾¦å–®ä½</p>
        </div>

        <div class="actions">
          <a href="https://status.criterium.tw/event.html" class="btn btn-secondary">
            è¿”å›æ´»å‹•é é¢
          </a>
          <a href="javascript:window.print()" class="btn btn-primary">
            åˆ—å°æ”¶æ“š
          </a>
        </div>

        <div class="footer">
          è¨‚å–®ç·¨è™Ÿï¼š${data.orderNo || '-'}<br>
          å¦‚éœ€å”åŠ©è«‹è¯ç¹«ï¼šinfo@criterium.tw
        </div>
      `;
    }

    // é¡¯ç¤ºéŒ¯èª¤é é¢
    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="success-icon" style="background: #dc3545;">
          <span class="error-icon">âœ—</span>
        </div>
        
        <h1>âŒ ä»˜æ¬¾å¤±æ•—</h1>
        <p class="subtitle">
          å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„ä»˜æ¬¾æœªèƒ½æˆåŠŸå®Œæˆ<br>
          ${message || 'è«‹é‡æ–°å˜—è©¦æˆ–è¯ç¹«å®¢æœäººå“¡'}
        </p>

        <div class="notice-box" style="background: #f8d7da; border-color: #dc3545;">
          <strong style="color: #721c24;">å¯èƒ½åŸå› </strong>
          <p style="color: #721c24;">â€¢ ä»˜æ¬¾éç¨‹ä¸­æ–·</p>
          <p style="color: #721c24;">â€¢ ä¿¡ç”¨å¡è³‡è¨Šä¸æ­£ç¢º</p>
          <p style="color: #721c24;">â€¢ è¶…éä»˜æ¬¾æ™‚é™</p>
          <p style="color: #721c24;">â€¢ ç³»çµ±è™•ç†ç•°å¸¸</p>
        </div>

        <div class="actions">
          <a href="https://status.criterium.tw/eventregister.html" class="btn btn-primary">
            é‡æ–°å ±å
          </a>
          <a href="mailto:info@criterium.tw" class="btn btn-secondary">
            è¯ç¹«å®¢æœ
          </a>
        </div>

        <div class="footer">
          å¦‚éœ€å”åŠ©è«‹è¯ç¹«ï¼šinfo@criterium.tw
        </div>
      `;
    }

    // é¡¯ç¤ºå¾…ç¹³è²»é é¢ï¼ˆATM/è¶…å•†ï¼‰
    function showPending(data) {
      document.getElementById('content').innerHTML = `
        <div class="success-icon" style="background: #ffc107;">â³</div>
        
        <h1>â° ç­‰å¾…ä»˜æ¬¾ä¸­</h1>
        <p class="subtitle">
          æ‚¨çš„è¨‚å–®å·²å»ºç«‹ï¼Œè«‹å„˜é€Ÿå®Œæˆç¹³è²»
        </p>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">è¨‚å–®ç·¨è™Ÿ</span>
            <span class="info-value highlight">${data.orderNo || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">å ±åè€…</span>
            <span class="info-value">${data.name || '-'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">æ‡‰ç¹³é‡‘é¡</span>
            <span class="info-value highlight">NT$ ${data.tradeAmt ? parseInt(data.tradeAmt).toLocaleString() : '-'}</span>
          </div>
        </div>

        <div class="notice-box">
          <strong>ğŸ’¡ ç¹³è²»èªªæ˜</strong>
          <p>â€¢ ç¹³è²»è³‡è¨Šå·²å¯„é€è‡³æ‚¨çš„ä¿¡ç®±</p>
          <p>â€¢ è«‹æ–¼æœŸé™å…§å®Œæˆç¹³è²»</p>
          <p>â€¢ å®Œæˆç¹³è²»å¾Œç´„éœ€ 2-3 å°æ™‚è™•ç†æ™‚é–“</p>
          <p>â€¢ å¦‚æœ‰å•é¡Œè«‹è¯ç¹«å®¢æœ</p>
        </div>

        <div class="actions">
          <a href="https://status.criterium.tw/event.html" class="btn btn-secondary">
            è¿”å›æ´»å‹•é é¢
          </a>
        </div>

        <div class="footer">
          è¨‚å–®ç·¨è™Ÿï¼š${data.orderNo || '-'}<br>
          å¦‚éœ€å”åŠ©è«‹è¯ç¹«ï¼šinfo@criterium.tw
        </div>
      `;
    }

    // åˆå§‹åŒ–é é¢
    async function init() {
      const params = getUrlParams();
      
      console.log('URL åƒæ•¸:', params);

      // åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹
      if (params.rtnCode === '1') {
        // ä»˜æ¬¾æˆåŠŸ
        showSuccess(params);
      } else if (params.rtnCode && params.rtnCode !== '1') {
        // ä»˜æ¬¾å¤±æ•—
        showError(params.rtnMsg || 'ä»˜æ¬¾è™•ç†å¤±æ•—');
      } else if (params.orderNo) {
        // å¯èƒ½æ˜¯ ATM/è¶…å•†ç­‰å¾…ä»˜æ¬¾
        // å¯ä»¥é¸æ“‡å‘¼å« API æŸ¥è©¢è¨‚å–®ç‹€æ…‹
        try {
          const response = await fetch(`${CONFIG.checkOrderUrl}?order_no=${params.orderNo}`);
          if (response.ok) {
            const orderData = await response.json();
            if (orderData.status === 'paid') {
              showSuccess(orderData);
            } else {
              showPending(orderData);
            }
          } else {
            showPending(params);
          }
        } catch (error) {
          console.error('æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
          showPending(params);
        }
      } else {
        // æ²’æœ‰ä»»ä½•åƒæ•¸
        showError('æ‰¾ä¸åˆ°è¨‚å–®è³‡è¨Š');
      }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
